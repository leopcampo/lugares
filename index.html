<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizador de Mesas – Casamento (Drag & Drop)</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --card:#0b1225;        /* custom */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#38bdf8;    /* sky-400 */
      --text:#e5e7eb;        /* gray-200 */
      --text-dim:#9ca3af;    /* gray-400 */
      --ok:#10b981;          /* emerald-500 */
      --warn:#f59e0b;        /* amber-500 */
      --danger:#ef4444;      /* red-500 */
      --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 100% 0, #0b1534, transparent), var(--bg);
      color:var(--text);
    }

    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:16px clamp(12px, 3vw, 28px);
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.8));
      border-bottom:1px solid rgba(148,163,184,.12);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:36px; height:36px; border-radius:12px; background:linear-gradient(145deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow)}
    h1{font-size: clamp(18px, 2.6vw, 24px); margin:0; letter-spacing:.5px}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px}
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, #0d142c, #0b1225);
      color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow);
      transition:.2s transform, .2s background, .2s border-color, .2s opacity;
      font-weight:600; font-size:14px;
    }
    .btn:hover{transform:translateY(-1px); border-color: rgba(148,163,184,.35)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(180deg, #0d1b3d, #0b1534); border-color: rgba(56,189,248,.55)}
    .btn.ok{border-color: rgba(16,185,129,.5)}
    .btn.warn{border-color: rgba(245,158,11,.5)}
    .btn.danger{border-color: rgba(239,68,68,.5)}
    .btn.small{padding:6px 10px; font-size:12px}

    .wrap{
      display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; max-width: 1400px; margin:0 auto;
    }
    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr;}
    }

    .panel{
      background:linear-gradient(180deg, var(--panel), #0d162f);
      border:1px solid rgba(148,163,184,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Convidados */
    .guests{display:flex; flex-direction:column; min-height:300px}
    .guests header{position:unset; background:none; border:0; padding:16px}
    .guest-inputs{display:flex; gap:8px; flex-wrap:wrap}
    .input{flex:1; min-width:140px; background:#0a1226; color:var(--text); border:1px solid rgba(148,163,184,.2); border-radius:10px; padding:10px 12px}
    .list{padding:12px 14px 18px; display:grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap:10px}
    .chip{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:8px 10px; border-radius:12px; background:linear-gradient(180deg, #0f1a35, #0b142c);
      border:1px solid rgba(148,163,184,.16); cursor:grab; user-select:none;
    }
    .chip[draggable="true"]{touch-action:none}
    .chip .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chip .x{opacity:.8; cursor:pointer}

    /* Mesas */
    .tables{padding:14px; display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:14px}
    .table{
      background:linear-gradient(180deg, #0c142b, #0a1124);
      border:1px solid rgba(148,163,184,.16);
      padding:12px; border-radius:18px; display:flex; flex-direction:column; gap:10px; position:relative;
      min-height:220px;
    }
    .table-title{display:flex; align-items:center; gap:8px}
    .table-title input{flex:1; background:transparent; border:1px dashed rgba(148,163,184,.25); color:var(--text); padding:8px 10px; border-radius:10px; font-weight:600}
    .seat-grid{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin-top:8px}
    .seat{
      height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; text-align:center; padding:6px;
      border:1px dashed rgba(148,163,184,.28);
      background:linear-gradient(180deg, #0b1327, #0a1122);
      position:relative;
    }
    .seat.occupied{border-style:solid; border-color: rgba(56,189,248,.6);}
    .seat .seat-label{position:absolute; top:6px; left:8px; font-size:11px; color:var(--text-dim)}
    .seat .guest-name{font-weight:600; font-size:13px; line-height:1.1; overflow:hidden; text-overflow:ellipsis}

    .table-actions{display:flex; gap:6px; flex-wrap:wrap}
    .muted{color:var(--text-dim); font-size:12px}

    /* Destacar drop */
    .drop-hover{outline:2px dashed var(--accent); outline-offset:2px}

    /* Rodapé */
    footer{padding:12px; text-align:center; color:var(--text-dim); font-size:12px}

    /* Impressão */
    @media print{
      header, .guests, .toolbar .btn:not(.print-only){display:none !important}
      body{background:white; color:black}
      .wrap{display:block; padding:0}
      .tables{display:grid; grid-template-columns: repeat(2, 1fr)}
      .table{break-inside: avoid; border:1px solid #000}
      .seat{border:1px solid #000}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Organizador de Mesas – Casamento</h1>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="addTableBtn">+ Adicionar mesa</button>
      <button class="btn ok" id="autoSeatBtn" title="Distribui convidados não alocados aleatoriamente">Distribuir automático</button>
      <button class="btn" id="saveBtn" title="Salva no navegador">Salvar</button>
      <button class="btn" id="loadBtn" title="Carrega do navegador">Carregar</button>
      <button class="btn" id="exportBtn">Exportar JSON</button>
      <button class="btn" id="importBtn">Importar JSON</button>
      <button class="btn warn print-only" onclick="window.print()">Imprimir</button>
      <button class="btn danger" id="clearAllBtn">Zerar tudo</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Painel de Convidados -->
    <section class="panel guests" aria-label="Convidados">
      <header>
        <h2 style="margin:0 0 8px 0; font-size:18px">Convidados</h2>
        <div class="guest-inputs">
          <input id="guestName" class="input" type="text" placeholder="Nome do convidado" />
          <button id="addGuestBtn" class="btn ok">Adicionar</button>
          <button id="bulkBtn" class="btn">Adicionar em lote</button>
		  <input id="searchGuest" class="input" type="text" placeholder="Pesquisar convidado..." style="margin-top:10px;width:100%" />
        </div>
        
      </header>
      <div id="guestList" class="list" aria-live="polite"></div>
    </section>

    <!-- Mesas -->
    <section class="panel" aria-label="Mesas">
      <div class="tables" id="tables"></div>
    </section>
  </main>

  <footer>
    Feito com ❤️.Te amo mozãoo0.
  </footer>

  <input type="file" id="fileInput" accept="application/json" hidden />

  <script>
  // ======= Estado =======
  const state = {
    guests: [],        // {id, name}
    tables: [],        // {id, name, seats: [guestId|null, ...]}
    seq: 1
  }

  // Utilitário para IDs
  const newId = () => 'id_' + (state.seq++).toString(36) + '_' + Math.random().toString(36).slice(2,8)

  // ======= Persistência =======
  const save = () => {
    localStorage.setItem('wedding-planner', JSON.stringify(state))
    toast('Salvo!')
  }
  const load = () => {
    const raw = localStorage.getItem('wedding-planner')
    if(!raw) return toast('Nada salvo ainda.')
    try{
      const obj = JSON.parse(raw)
      Object.assign(state, obj)
      renderAll()
      toast('Carregado!')
    }catch(e){
      alert('Falha ao carregar: ' + e.message)
    }
  }

  const exportJSON = () => {
    const data = JSON.stringify(state, null, 2)
    const blob = new Blob([data], {type:'application/json'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = 'mesas-casamento.json'
    a.click()
    setTimeout(()=>URL.revokeObjectURL(url), 1000)
  }
  
  const importJSON = () => {
    const fileInput = document.getElementById('fileInput')
    fileInput.onchange = () => {
      const file = fileInput.files[0]
      if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result)
          Object.assign(state, obj)
          renderAll()
          toast('Importado!')
        }catch(e){
          alert('Arquivo inválido: ' + e.message)
        }
      }
      reader.readAsText(file)
    }
    fileInput.click()
  }

  // ======= Toast simples =======
  let toastT
  const toast = (msg) => {
    const el = document.createElement('div')
    el.textContent = msg
    el.style.position = 'fixed'
    el.style.bottom = '16px'
    el.style.left = '50%'
    el.style.transform = 'translateX(-50%)'
    el.style.background = 'rgba(15,23,42,.95)'
    el.style.border = '1px solid rgba(148,163,184,.35)'
    el.style.padding = '10px 14px'
    el.style.borderRadius = '10px'
    el.style.boxShadow = 'var(--shadow)'
    document.body.appendChild(el)
    clearTimeout(toastT)
    toastT = setTimeout(()=> el.remove(), 1600)
  }

  // ======= Convidados =======
  function addGuest(name){
    name = (name||'').trim()
    if(!name) return
    const exists = state.guests.some(g => g.name.toLowerCase() === name.toLowerCase())
    const g = {id: newId(), name}
    state.guests.push(g)
    renderGuests()
  }

  function removeGuest(id){
    // Se convidado estiver sentado, libere o assento
    for(const t of state.tables){
      t.seats = t.seats.map(s => s === id ? null : s)
    }
    state.guests = state.guests.filter(g => g.id !== id)
    renderAll()
  }

  function renderGuests(){
    const list = document.getElementById('guestList')
    list.innerHTML = ''
    const unseatedIds = new Set(getUnseatedGuests().map(g=>g.id))
	const term=document.getElementById('searchGuest').value.toLowerCase()
    for(const g of state.guests){
	  if(term && !g.name.toLowerCase().includes(term)) continue
      const chip2=document.createElement('div')
      chip2.className='chip'; chip2.draggable=true; chip2.dataset.guestId=g.id
      //chip2.innerHTML=`<span class="name">${g.name}</span><span class="x">✕</span>`
      //chip2.addEventListener('dragstart', onGuestDragStart)
      //chip2.querySelector('.x').onclick=()=>removeGuest(g.id)
      list.appendChild(chip2)
      if(!unseatedIds.has(g.id)) continue // só mostra não alocados
      const chip = document.createElement('div')
      chip.className = 'chip'
      chip.draggable = true
      chip.dataset.guestId = g.id
      chip.innerHTML = `<span class="name">${escapeHtml(g.name)}</span><span class="x" title="Remover">✕</span>`

      chip.addEventListener('dragstart', onGuestDragStart)
      chip.addEventListener('touchstart', touchDragStart)
      chip.querySelector('.x').onclick = () => removeGuest(g.id)

      list.appendChild(chip)
    }
  }

  function getUnseatedGuests(){
    const seated = new Set()
    for(const t of state.tables){
      for(const s of t.seats){ if(s) seated.add(s) }
    }
    return state.guests.filter(g => !seated.has(g.id))
  }

  // ======= Mesas & Assentos =======
  function addTable(){
    state.tables.push({id:newId(), name:`Mesa ${state.tables.length+1}`, seats:Array(8).fill(null)})
    renderTables()
  }

  function changeSeatCount(tableId, delta){
    const t = state.tables.find(t=>t.id===tableId)
    if(!t) return
    if(delta>0){
      t.seats.push(...Array(delta).fill(null))
    } else {
      const removeN = Math.min(Math.abs(delta), t.seats.length)
      for(let i=0;i<removeN;i++){
        const removed = t.seats.pop()
        // se tinha alguém, volta para lista automaticamente (render cuida)
      }
    }
    renderTables()
  }

  function renameTable(tableId, name){
    const t = state.tables.find(t=>t.id===tableId)
    if(!t) return
    t.name = name
  }

  function renderTables(){
    const wrap = document.getElementById('tables')
    wrap.innerHTML = ''

    state.tables.forEach((t, ti)=>{
      const card = document.createElement('div')
      card.className = 'table'

      const title = document.createElement('div')
      title.className = 'table-title'
      title.innerHTML = `
        <input value="${escapeHtml(t.name)}" aria-label="Nome da mesa" />
        <div class="table-actions">
          <button class="btn small" title="Adicionar 1 assento">+1</button>
          <button class="btn small" title="Remover 1 assento">−1</button>
          <button class="btn small danger" title="Excluir mesa">Excluir</button>
        </div>
      `
      const nameInput = title.querySelector('input')
      nameInput.addEventListener('input', (e)=> renameTable(t.id, e.target.value))
      const [btnPlus, btnMinus, btnDelete] = title.querySelectorAll('button')
      btnPlus.onclick = ()=> changeSeatCount(t.id, +1)
      btnMinus.onclick = ()=> changeSeatCount(t.id, -1)
      btnDelete.onclick = ()=> { if(confirm('Excluir esta mesa?')){ state.tables = state.tables.filter(x=>x.id!==t.id); renderAll()} }

      const grid = document.createElement('div')
      grid.className = 'seat-grid'

      t.seats.forEach((guestId, si)=>{
        const seat = document.createElement('div')
        seat.className = 'seat' + (guestId? ' occupied':'')
        seat.dataset.tableId = t.id
        seat.dataset.index = si
        seat.innerHTML = `<span class="seat-label">${si+1}</span><div class="guest-name">${guestId? escapeHtml(guestName(guestId)) : 'Vazio'}</div>`

        seat.addEventListener('dragover', (e)=>{ e.preventDefault(); seat.classList.add('drop-hover') })
        seat.addEventListener('dragleave', ()=> seat.classList.remove('drop-hover'))
        seat.addEventListener('drop', (e)=> onSeatDrop(e, seat))
        seat.addEventListener('click', ()=>{
          // Clique remove convidado do assento
          const idx = Number(seat.dataset.index)
          const table = state.tables.find(x=>x.id===seat.dataset.tableId)
          if(table.seats[idx]){ table.seats[idx] = null; renderAll() }
        })
        grid.appendChild(seat)
      })

      card.appendChild(title)
      card.appendChild(grid)
      wrap.appendChild(card)
    })
  }

  function guestName(id){
    const g = state.guests.find(g=>g.id===id)
    return g? g.name : '(Removido)'
  }

  // ======= Drag & Drop =======
  function onGuestDragStart(e){
    const id = e.currentTarget.dataset.guestId
    e.dataTransfer.setData('text/plain', id)
    e.dataTransfer.effectAllowed = 'move'
  }

  function onSeatDrop(e, seat){
    e.preventDefault();
    seat.classList.remove('drop-hover')
    const guestId = e.dataTransfer.getData('text/plain')
    if(!guestId) return
    const table = state.tables.find(t=>t.id===seat.dataset.tableId)
    const idx = Number(seat.dataset.index)

    // Se já houver alguém, vamos fazer swap
    const current = table.seats[idx]

    // Remover o convidado do assento anterior (se houver)
    for(const t of state.tables){
      for(let i=0;i<t.seats.length;i++){
        if(t.seats[i] === guestId){ t.seats[i] = null }
      }
    }

    if(current && current !== guestId){
      // Colocar o atual no lugar de onde o convidado veio? Apenas libera e segue.
      // (comportamento simples). Poderia ser um swap real se quisermos: encontrar um assento vazio para o que estava.
    }

    table.seats[idx] = guestId
    renderAll()
  }

  // Suporte básico a mobile: simula drag iniciando por toque longo
  let touchDrag = null
  function touchDragStart(ev){
    const el = ev.currentTarget
    const id = el.dataset.guestId
    if(!id) return
    ev.preventDefault()

    const ghost = el.cloneNode(true)
    ghost.style.position = 'fixed'
    ghost.style.pointerEvents = 'none'
    ghost.style.opacity = .85
    ghost.style.transform = 'scale(1.02)'
    ghost.style.zIndex = 9999
    document.body.appendChild(ghost)

    const move = (e)=>{
      const t = e.touches[0]
      ghost.style.left = (t.clientX-50)+'px'
      ghost.style.top = (t.clientY-20)+'px'
    }

    const end = (e)=>{
      document.removeEventListener('touchmove', move)
      document.removeEventListener('touchend', end)
      ghost.remove()
      const t = e.changedTouches[0]
      const dropTarget = document.elementFromPoint(t.clientX, t.clientY)
      const seat = dropTarget && dropTarget.closest('.seat')
      if(seat){
        // Simula um drop
        const dt = new DataTransfer()
        dt.setData('text/plain', id)
        const fakeEvent = new DragEvent('drop', {dataTransfer: dt, bubbles:true})
        seat.dispatchEvent(fakeEvent)
      }
    }

    document.addEventListener('touchmove', move, {passive:false})
    document.addEventListener('touchend', end)
  }

  // ======= Utilidades =======
  function escapeHtml(str){
    return str.replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]))
  }

  // Distribuição automática simples
  function autoSeat(){
    const freeSeats = []
    state.tables.forEach((t,ti)=> t.seats.forEach((g,si)=>{ if(!g) freeSeats.push({ti,si}) }))
    const free = freeSeats.length
    const unseated = getUnseatedGuests().slice()
    if(unseated.length===0) return toast('Todos já estão alocados ou não há convidados.')
    if(free===0) return toast('Não há assentos livres.')
    // Embaralha
    for(let i=unseated.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [unseated[i], unseated[j]]=[unseated[j], unseated[i]] }
    const use = Math.min(unseated.length, free)
    for(let i=0;i<use;i++){
      const {ti,si} = freeSeats[i]
      state.tables[ti].seats[si] = unseated[i].id
    }
    renderAll()
  }

  function clearAll(){
    if(!confirm('Tem certeza que deseja zerar tudo?')) return
    state.guests = []
    state.tables = []
    state.seq = 1
    renderAll()
  }

  // ======= Render raiz =======
  function renderAll(){ renderGuests(); renderTables() }

  // ======= Controles =======

  document.getElementById('searchGuest').addEventListener('input',renderGuests)
  document.getElementById('addGuestBtn').onclick = ()=>{
    addGuest(document.getElementById('guestName').value)
    document.getElementById('guestName').value=''
  }
  document.getElementById('guestName').addEventListener('keydown', (e)=>{
    if(e.key==='Enter') document.getElementById('addGuestBtn').click()
  })

  document.getElementById('bulkBtn').onclick = ()=>{
    const txt = prompt('Cole aqui nomes (um por linha):')
    if(!txt) return
    txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(addGuest)
  }
  
  document.getElementById('addTableBtn').onclick = addTable
  document.getElementById('autoSeatBtn').onclick = autoSeat
  document.getElementById('saveBtn').onclick = save
  document.getElementById('loadBtn').onclick = load
  document.getElementById('exportBtn').onclick = exportJSON
  document.getElementById('importBtn').onclick = importJSON
  document.getElementById('clearAllBtn').onclick = clearAll

  // ======= Inicialização =======
  (function init(){
    // tenta carregar automaticamente
    try{
      const raw = localStorage.getItem('wedding-planner')
      if(raw){ Object.assign(state, JSON.parse(raw)) }
    }catch{}
    if(state.tables.length===0){ addTable() }
    renderAll()
  })()
  </script>
</body>
</html>
